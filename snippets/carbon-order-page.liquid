<div class="product" data-pf-type="ProductBox">
    <div class="centeral-content">
        <div class="featured_image">
            <div class="swiper left-swiper">
                <div class="swiper-wrapper">
                </div>
            </div>
            <div class="swiper right-swiper" style="--swiper-navigation-color: #fff;">
                <div class="swiper-wrapper">
                    {% comment %} {% for image in product.images %}
                        <div class="swiper-slide">
                            {{ image | image_url: width: 1000 | image_tag }}
                        </div>
                    {% endfor %} {% endcomment %}
                </div>
                <div class="swiper-button-prev"></div><!--左箭头。如果放置在swiper外面，需要自定义样式。-->
                <div class="swiper-button-next"></div><!--右箭头。如果放置在swiper外面，需要自定义样式。-->
            </div>
            <div></div>
            <div class="parameters">
                <div>
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18448_2x_833c8995-fa19-4297-af29-678ac4064d0c.png?v=1687176385"/>
                    <span><span class="u14Light_v2">Carbon Fiber</span><span class="u17DemiBold_v2">15 kg.</span></span>
                </div>
                <div>
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18449_2x_e118ab7b-18ca-4612-afb3-20758874d9c7.png?v=1687177181"/>
                    <span><span class="u14Light_v2">Carbon Fiber</span><span class="u17DemiBold_v2">15 kg.</span></span>
                </div>
                <div>
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18445_2x_2e6c6230-7ed1-4c3d-99ad-54ba48fa57b4.png?v=1687177370"/>
                    <span><span class="u14Light_v2">Carbon Fiber</span><span class="u17DemiBold_v2">15 kg.</span></span>
                </div>
                <div>
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18447_2x_c102facd-9087-4028-8f97-34a7af31b1f6.png?v=1687177414"/>
                    <span><span class="u14Light_v2">Carbon Fiber</span><span class="u17DemiBold_v2">15 kg.</span></span>
                </div>
                <div>
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18450_2x_50383af6-61df-4632-9cbc-531630580f61.png?v=1687177242"/>
                    <span><span class="u14Light_v2">Carbon Fiber</span><span class="u17DemiBold_v2">15 kg.</span></span>
                </div>
                <div>
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18446_2x_791e060a-ed39-42c5-9cf0-965d7e5110bb.png?v=1687177232"/>
                    <span><span class="u14Light_v2">Carbon Fiber</span><span class="u17DemiBold_v2">15 kg.</span></span>
                </div>
            </div>
        </div>
        <form method="post" accept-charset="UTF-8" action="/cart/add" class="product-panel pf-product-form" data-productid={{ product.id }} id="product_form_{{ product.id }}" enctype="multipart/form-data">
            <input type="hidden" name="id" data-product-id="{{product.id}}" value="{{ product.selected_or_first_available_variant.id }}"/>
            <input type="hidden" name="form_type" value="product">
            <input type="hidden" name="utf8" value="✓">
            <div class="u36DemiBold_v2 mb12">{{ product.title }}</div>
            <div data-pf-type="JudgeMe" class="sc-eZhRLC gtfCKx pf-25_ order-djs mb12">
                <div class="pf-judme">{% render "judgeme_widgets", widget_type: "judgeme_preview_badge", jm_style: "", concierge_install: false, product: product %}</div>
            </div>
            <div class="u30DemiBold_v2 mb12">{{ product.price | money }}</div>
            <div class="sale mb12">
                <div class="u20DemiBold_v2">€2.699,00 NOW</div>
                <div class="u17DemiBold_v2">with Green travel sale</div>
            </div>
            <div class="sale_acc mb12">
                <div class="u14Light_v2">And get €169 Accessories for <span class="u20DemiBold_v2">Free</span></div>
                {% assign accessories_map = "7633738596568,7633738662104,7633738531032" | split: ',' %}
                <div class="accs">
                    {% for acc in accessories_map %}
                        {% for prod in collections["accessories"].products %}
                            {% if acc contains prod.id %}
                                <div class="acc">
                                    {{ prod.featured_image | image_url: width: 400 | image_tag }}
                                    {% if acc == "7633738662104" %}
                                        <span class="u11Medium_v2">{{ prod.title | truncatewords: 3, "" | replace: "-", "" }}</span>
                                    {% else %}
                                        <span class="u11Medium_v2">{{ prod.title }}</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </div>
                <div class="u11Light_v2">*Not available with leasing</div>
            </div>
            <div class="count-down mb12">
                <div class="u17Medium_v2">€600 off + 3 Free Accessories Ends in：</div>
            </div>
            <div class="options">
                {% for option in product.options %}
                    <div class="option" option={{option}}>
                        <div class="u17DemiBold_v2 mb12">{{ option }} - <span class="u17Light_v2"></span></div>
                        <div class="{{ option }} mb12"></div>
                    </div>
                {% endfor %}
            </div>
            <div class="accessories">
                <div class="u17DemiBold_v2 mb12">Gears you need</div>
                <div class="navigate">
                    <div class="prev"></div>
                    <div class="next"></div>
                </div>
                <div class="items mb12">
                    {% for prod in collections['on-page'].products %}
                        {% assign variant = prod.variants | first %}
                        <div class="item" variant-id="{{ variant.id }}">
                            {{ prod.featured_image | image_url: width: 400 | image_tag }}
                            <div>
                                <span class=u11Light_v2>+</span>
                                <span class="u17DemiBold_v2">{{ prod.price | money }}</span>
                                <span class="u11Medium_v2">{{ prod.title }}</span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="buttons">
                <div
                    data-product-id="{{ product.id }}"
                    class="my-button my-button-origin addToCartBtn"
                    onclick="addAllToCart('atc')"
                    id="addToCart"
                    >
                    <i class="fa fa-spinner fa-spin"></i><span data-pf-type="Text" class="addToCartText">Add to Cart</span>
                </div>
                <div onclick="testRideTrace('lease_on_jobrad', this)" class="orderTestRideBtn">
                    <img class="oneeee" src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/jobradorg_2x_423443a0-1c79-4785-97a0-2be8ae66ceb6.png?v=1685414275"/>
                    <span><span class="u17DemiBold_v2">TAX FREE Leasing</span><span>36 months, €48/month</span></span>
                  </div>
                  <div onclick="testRideTrace('klarna_check_out', this)" class="orderTestRideBtn">
                    <img class="twoooo"src="https://cdn.shopifycdn.net/s/files/1/0633/2068/6808/files/20230530-121400.png?v=1685420054"/>
                    <span><span class="u17DemiBold_v2">0% APR Financing</span><span>24 months, €112/month</span></span>
                </div>
            </div>
            <div class="delivery_time mb12">Free shipping <span>within 5 days</span></div>
            <div class="support mb12">
                <div>
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_17960_2x_4a54d2f0-0a38-45e6-8cc0-6c040b1f5d6c.png?v=1687161120"/>
                    <span class="u11Medium_v2">Free<br>Shipping</span>
                </div>
                <div>
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_17959_2x_cff00041-4dce-479b-b87d-55b1cb89cd7a.png?v=1687161086"/>
                    <span class="u11Medium_v2">14-Day<br>Returns</span>
                </div>
                <div>
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_17958_2x_1e776f09-0686-4672-a22f-b29d2df3898d.png?v=1687161098"/>
                    <span class="u11Medium_v2">2-Year<br>Warranty</span>
                </div>
            </div>
            <div class="dialogs">
                <div class="u17Medium_v2">
                    <span>Size & Fit</span>
                    <span>&gt;</span>
                </div>
                <div class="u17Medium_v2">
                    <span>Technical Specifications</span>
                    <span>&gt;</span>
                </div>
                <div class="u17Medium_v2">
                    <span>Peace of Mind Service</span>
                    <span>&gt;</span>
                </div>
                <div class="u17Medium_v2">
                    <span>FAQs</span>
                    <span>&gt;</span>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    const search = getSearchValues()
    const variants = JSON.parse(JSON.stringify({{ product.variants | json }}))
    const size_map = {
        M: 'Fit for 170-185 cm',
        L: 'Fit for 180-195 cm'
    }

    let current_variant_id = null
    let current_variant = null
    const styles = {}
    const sizes = {}

    const commonSwiper = [
        'https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18645_2x_43f4d7ad-7903-459e-aeb0-91ae96d4b7f6.png?v=1687180003',
        'https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18644_2x_e0aa20ff-1158-4513-bc46-707c4927815b.png?v=1687180008',
        'https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18643_2x_2b1badee-eb84-4768-887b-ce81125a4662.png?v=1687180017',
        'https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18642_2x_a05a328d-d8bc-44fc-a033-9c8c7d714090.png?v=1687180019',
        'https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18641_2x_52b34b6c-484b-4e87-840c-8b9e4df0f717.png?v=1687180025',
        'https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18640_2x_e7fbb634-148d-42e6-bd3d-5ed96ac54a5d.png?v=1687180032'
    ]

    const swiper_series = {
        Sirius: [
            "https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18515_2x_7f099482-44b8-4fa9-80cc-ec874426129a.png?v=1687182170",
            "https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18527_2x_50db6568-1cec-4122-bea9-f2865377e03d.png?v=1687182155",
            "https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18528_2x_86d3fd70-1b9f-4249-8538-95851658c7f1.png?v=1687182142"
        ],
        Lyra: [
            'https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18525_2x_f631983d-4ffb-4d7c-8bd3-780e1febcbd7.png?v=1687182802'
        ],
        "Midnight in Paris": [
            "https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18526_2x_31185c82-c43d-4880-93f6-21812c9ab738.png?v=1687182989"
        ],
        vanilla: [
            "https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18524_2x_d7634c80-58e5-45fe-9aad-3bade91436ff.png?v=1687183111",
            "https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18530_2x_dadf383f-0350-4b94-9938-f76f2fb32c8c.png?v=1687183129",
            "https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18529_2x_5d41e02c-0649-431f-9fc4-ccd6c6a22077.png?v=1687183118",
            "https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18531_2x_8986ab6b-26cd-4638-a63b-8d0e1fe9d724.png?v=1687183134",
            "https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Mask_Group_18532_2x_f4e294fc-7530-49dc-96bc-94f59b52ddc4.png?v=1687183139"
        ]
    }
    
    const leftSwiper = new Swiper(".product .left-swiper", {
        direction: 'vertical',
        {% comment %} spaceBetween: 15, {% endcomment %}
        slidesPerView: 8,
        freeMode: true,
        watchSlidesProgress: true,
      })

      const rightSwiper = new Swiper(".product .right-swiper", {
        autoHeight: true,
        navigation: {
          nextEl: ".product .right-swiper .swiper-button-next",
          prevEl: ".product .right-swiper .swiper-button-prev",
        },
        effect: 'fade',
        fadeEffect:{
            crossFade: true
        },
        thumbs: {
          swiper: leftSwiper,
        },
      });

    function findVariantOptions (style, size) {
        return variants.find(v => `${style} / ${size}` === v.title)
    }

    function findVariantFromId (id) {
        return variants.find(v => String(v.id) === String(id))
    }

    function findAvailableVariant () {
        return variants.find(v => v.available)
    }

    function changeVariant (style, size) {
        if (style) {
            $(`.product .product-panel .Style .active`).removeClass('active')
            $(`.product .product-panel .Style > div[attribute="${style}"]`).addClass('active')
            $(`.product .product-panel .options > div[option="Style"] .u17DemiBold_v2 .u17Light_v2`).text(style)

            let swiper_arr = []
            swiper_arr = swiper_arr.concat(swiper_series[style], style === 'vanilla' ? [] : commonSwiper)

            $('.product .right-swiper .swiper-wrapper').html(swiper_arr.map(s => `<div class="swiper-slide"><img src="${s}"></div>`).join(''))
            $('.product .left-swiper .swiper-wrapper').html(swiper_arr.map(s => `<div class="swiper-slide"><img src="${s}"></div>`).join(''))
            
            // update
            setTimeout(() => {
                rightSwiper.update()
                leftSwiper.update()
            }, 100)
        }

        if (size) {
            $(`.product .product-panel .Size .active`).removeClass('active')
            $(`.product .product-panel .Size > div[attribute="${size}"]`).addClass('active')
            $(`.product .product-panel .options > div[option="Size"] .u17DemiBold_v2 .u17Light_v2`).text(size_map[size])
        }


        if (style && size) {
            current_variant = findVariantOptions(style, size)
            current_variant_id = current_variant.id


            history.replaceState(null, '', `${location.pathname}?variant=${current_variant_id}`);
            $('.product .product-panel input[name="id"]').val(current_variant_id)
            $('.product .delivery_time').text(global_config.ebike_delivery_time[current_variant_id])

            const btn =  $('.product .buttons .addToCartBtn')
            if (current_variant.available) {
                btn.find('span').text('Add to Cart')
                btn.removeClass('disabled')
            } else {
                btn.find('span').text('Sold out')
                btn.addClass('disabled')
            }
        }

        console.log(current_variant)
    }


    function changeAddToCartText (parse, step = 0) {
        if (step) {
            $(".addToCartBtn i").toggleClass("showi");
            document.querySelector(".addToCartBtn span").innerHTML = "Adding...";
        } else {
            setTimeout(()=>{
                $(".addToCartBtn i").toggleClass("showi");
                document.querySelector(".addToCartBtn span").innerHTML = "Add to Cart";
            }, 800)
        }
    }

    function testRideTrace(type = '', target){

        // 如果已经有按钮 loading ,直接退出来
        if (!type || $('.orderTestRideBtn').hasClass('loading')) {
            return
        }
    
        const t = $(target)
    
        t.addClass('loading')
        // 原本的html 存起来
        const text = t.find('span').html()
        const loading = '<i class="fa fa-spinner fa-spin"></i>Processing...'
    
        // loading
        t.find('span').html(loading)
    
        
    
        if (type === 'lease_on_jobrad') {
            fetchBuried('websiteclick', `carbon-order-page`, { button: type }, true)
    
            t.removeClass('loading')
            t.find('span').html(text)
            return window.open(`/pages/ebike-leasing?bike_style=${current_variant.option1}&bike_size=${current_variant.option2}&utm_source=order_page#forms`)
        }
    
        if (type === 'klarna_check_out') {
            fetchBuried('websiteclick', `carbon-order-page`, { button: type, action_type: sessionStorage.carbon_one_a_b_test_flag }, true)
            window.sessionStorage.clicked_klarna_checkout_button = 'clicked_klarna_checkout_button'
    
            if (sessionStorage.carbon_one_a_b_test_flag === 'B') {
                setTimeout(() => {
                    t.removeClass('loading')
                    t.find('span').html(text)
                }, 2000)
                // 如果 B test 需要显示 klarna checkout
                window.show_notification_checkout_button = true
                return addToCartInsurance("atc", true)
            }
    
            const body = { items: [{ id: current_variant_id, quantity: 1 }] }
            body.items = body.items.concat(global_config.event_accessories_variant_ids.map(id => ({ id, quantity: 1 })))
    
    
            console.log('body', body)
    
    
            return fetch(window.Shopify.routes.root + 'cart/add.js', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            }).then(response => {
                location.href = `/checkout?show_klarna_dialog=show_klarna_dialog`
            }).catch((error) => {
                t.removeClass('loading')
                t.find('span').html(text)
            
                console.error('Error:', error);
            })
        }
    
        if (type === 'shop_on_mediamarkt') {
            t.removeClass('loading')
            t.find('span').html(text)
            return window.open('https://www.mediamarkt.de/de/search.html?query=urtopia&filter=carType%3ACitybike')
          
        }
    }

    {% for variant in product.variants %}
        styles[{{ variant.option1 | json }}] = 1
        sizes[{{ variant.option2 | json }}] = 1
    {% endfor %}

    console.log('variants', variants)

    for (const style of Object.keys(styles)) {
        $('.product .product-panel .Style').append(`<div attribute="${style}" class="${style}"></div>`)
    }

    for (const size of Object.keys(sizes)) {
        $('.product .product-panel .Size').append(`<div attribute="${size}" class="${size} u17Light_v2">${size}</div>`)
    }


    $('.product-panel .options .option >div:not(.u17DemiBold_v2) > div').on('click',e => {
        const t = $(e.target)

        if ($(e.target).parent().hasClass('Style')) {
            changeVariant(t.attr('attribute'), current_variant.option2)
        } else {
            changeVariant(current_variant.option1, t.attr('attribute'))
        }
    })

    // 如果有查询参数
    if (search.variant) {
        changeVariant(findVariantFromId(search.variant).option1, findVariantFromId(search.variant).option2) 
    } else {
        changeVariant(findAvailableVariant().option1, findAvailableVariant().option2)
    }



    $('.accessories .navigate > div').on('click', e => {
        const items = $('.accessories .items')

        items.animate({
            scrollLeft: $('.accessories .items').scrollLeft() + ($(e.target).hasClass('next') ? 180 : -180)
        }, 300)
    })

    $('.accessories .items .item').on('click', e => {
        const item = $(e.target).closest('.item')

        item.hasClass('active') ? item.removeClass('active') : item.addClass('active')
    })

    $('.product .product-panel').on("submit", function (event) {

        // 阻止默认行为
        event.preventDefault();
        return false;
    })

    $('.product .dialogs > div').on('click', e => {
        const m = {
            0: 'one',
            1: 'two',
            2: 'three',
            3: 'four'
        }

        $('.product .dialogs > div').each((i, t) => {
            if ($(e.target).closest('.u17Medium_v2')[0] === t) {
                console.log(i)

                const layer = document.querySelector(`.order-modal-${m[i]}`);
                const laybox = document.querySelector(`.order-modal-layer-${m[i]}`);
                layer.style.display = "flex";
                laybox.className += " dialog-open";
            }
        })
    })

    

    

    

    {% comment %} window.addEventListener('load', e => {
        $('.product .product-panel .buttons').prepend($('.js-insurance-product-template').html())
        $('.product .product-panel').prepend($('.js-insurance-metafields-template').html())
    }) {% endcomment %}
    
</script>