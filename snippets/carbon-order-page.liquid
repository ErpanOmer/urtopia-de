<div class="product" data-pf-type="ProductBox">
    <div class="centeral-content">
        <div></div>
        <form method="post" accept-charset="UTF-8" action="/cart/add" class="product-panel pf-product-form" data-productid={{ product.id }} id="product_form_{{ product.id }}" enctype="multipart/form-data">
            <input type="hidden" name="id" data-product-id="{{product.id}}" value="{{ product.selected_or_first_available_variant.id }}"/>
            <input type="hidden" name="form_type" value="product">
            <input type="hidden" name="utf8" value="✓">
            <div class="u36DemiBold_v2 mb16">{{ product.title }}</div>
            <div class="u30DemiBold_v2 mb16">{{ product.price | money }}</div>
            <div class="sale mb16">
                <div class="u20DemiBold_v2">€2.699,00 NOW</div>
                <div class="u17DemiBold_v2">with Green travel sale</div>
            </div>
            <div class="sale_acc mb16">
                <div class="u14Light_v2">And get €169 Accessories for <span class="u20DemiBold_v2">Free</span></div>
                {% assign accessories_map = "7633738596568,7633738662104,7633738531032" | split: ',' %}
                <div class="accs">
                    {% for acc in accessories_map %}
                        {% for prod in collections["accessories"].products %}
                            {% if acc contains prod.id %}
                                <div class="acc">
                                    {{ prod.featured_image | image_url: width: 400 | image_tag }}
                                    {% if acc == "7633738662104" %}
                                        <span class="u11Medium_v2">{{ prod.title | truncatewords: 3, "" | replace: "-", "" }}</span>
                                    {% else %}
                                        <span class="u11Medium_v2">{{ prod.title }}</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </div>
                <div class="u11Light_v2">*Not available with leasing</div>
            </div>
            <div class="count-down mb16">
                <div class="u17Medium_v2">€600 off + 3 Free Accessories Ends in：</div>
            </div>
            <div class="options">
                {% for option in product.options %}
                    <div class="option" option={{option}}>
                        <div class="u17DemiBold_v2 mb16">{{ option }} - <span class="u17Light_v2"></span></div>
                        <div class="{{ option }} mb16"></div>
                    </div>
                {% endfor %}
            </div>
            <div class="accessories">
                <div class="u17DemiBold_v2 mb16">Gears you need</div>
                <div class="navigate">
                    <div class="prev"></div>
                    <div class="next"></div>
                </div>
                <div class="items mb16">
                    {% for prod in collections['on-page'].products %}
                        {% assign variant = prod.variants | first %}
                        <div class="item" variant-id="{{ variant.id }}">
                            {{ prod.featured_image | image_url: width: 400 | image_tag }}
                            <div>
                                <span class=u11Light_v2>+</span>
                                <span class="u17DemiBold_v2">{{ prod.price | money }}</span>
                                <span class="u11Medium_v2">{{ prod.title }}</span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="buttons">
                <div
                    data-product-id="{{ product.id }}"
                    class="my-button my-button-origin addToCartBtn"
                    onclick="addAllToCart('atc')"
                    id="addToCart"
                    >
                    <i class="fa fa-spinner fa-spin"></i><span data-pf-type="Text" class="addToCartText">Add to Cart</span>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    const search = getSearchValues()
    const variants = JSON.parse(JSON.stringify({{ product.variants | json }}))
    const size_map = {
        M: 'Fit for 170-185 cm',
        L: 'Fit for 180-195 cm'
    }

    let current_variant_id = null
    let current_variant = null
    const styles = {}
    const sizes = {}

    function findVariantOptions (style, size) {
        return variants.find(v => `${style} / ${size}` === v.title)
    }

    function findVariantFromId (id) {
        return variants.find(v => String(v.id) === String(id))
    }

    function findAvailableVariant () {
        return variants.find(v => v.available)
    }

    function changeAvive (style, size) {
        if (style) {
            $(`.product .product-panel .Style .active`).removeClass('active')
            $(`.product .product-panel .Style > div[attribute="${style}"]`).addClass('active')
            $(`.product .product-panel .options > div[option="Style"] .u17DemiBold_v2 .u17Light_v2`).text(style)
        }

        if (size) {
            $(`.product .product-panel .Size .active`).removeClass('active')
            $(`.product .product-panel .Size > div[attribute="${size}"]`).addClass('active')
            $(`.product .product-panel .options > div[option="Size"] .u17DemiBold_v2 .u17Light_v2`).text(size_map[size])
        }


        if (style && size) {
            current_variant = findVariantOptions(style, size)
            current_variant_id = current_variant.id


            history.replaceState(null, '', `${location.pathname}?variant=${current_variant_id}`);
            $('.product .product-panel input[name="id"]').val(current_variant_id)
        }

        console.log(current_variant)
    }


    function changeAddToCartText (parse, step = 0) {
        if (step) {
            $(".addToCartBtn i").toggleClass("showi");
            document.querySelector(".addToCartBtn span").innerHTML = "Adding";
        } else {
            setTimeout(()=>{
                $(".addToCartBtn i").toggleClass("showi");
                document.querySelector(".addToCartBtn span").innerHTML = "Add to Cart";
            }, 800)
        }

    }

    {% for variant in product.variants %}
        styles[{{ variant.option1 | json }}] = 1
        sizes[{{ variant.option2 | json }}] = 1
    {% endfor %}

    console.log('variants', variants)

    for (const style of Object.keys(styles)) {
        $('.product .product-panel .Style').append(`<div attribute="${style}" class="${style}"></div>`)
    }

    for (const size of Object.keys(sizes)) {
        $('.product .product-panel .Size').append(`<div attribute="${size}" class="${size} u17Light_v2">${size}</div>`)
    }


    $('.product-panel .options .option >div:not(.u17DemiBold_v2) > div').on('click',e => {
        const t = $(e.target)

        if ($(e.target).parent().hasClass('Style')) {
            changeAvive(t.attr('attribute'), current_variant.option2)
        } else {
            changeAvive(current_variant.option1, t.attr('attribute'))
        }
    })

    // 如果有查询参数
    if (search.variant) {
        changeAvive(findVariantFromId(search.variant).option1, findVariantFromId(search.variant).option2) 
    } else {
        changeAvive(findAvailableVariant().option1, findAvailableVariant().option2)
    }



    $('.accessories .navigate > div').on('click', e => {
        const items = $('.accessories .items')

        items.animate({
            scrollLeft: $('.accessories .items').scrollLeft() + ($(e.target).hasClass('next') ? 180 : -180)
        }, 300)
    })

    $('.accessories .items .item').on('click', e => {
        const item = $(e.target).closest('.item')

        item.hasClass('active') ? item.removeClass('active') : item.addClass('active')
    })

    $('.product .product-panel').on("submit", function (event) {

        // 阻止默认行为
        event.preventDefault();
        return false;
    })

    

    

    {% comment %} window.addEventListener('load', e => {
        $('.product .product-panel .buttons').prepend($('.js-insurance-product-template').html())
        $('.product .product-panel').prepend($('.js-insurance-metafields-template').html())
    }) {% endcomment %}
    
</script>